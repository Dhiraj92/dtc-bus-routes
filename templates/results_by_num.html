{% extends "index.html" %}

{% block title %}{{ block.super }} | Route {{ route }} | {{ startstage }} to {{ endstage }}{% endblock %}

{% block meta_tags %}
  <meta name="description" content="DTC Bus Routes | Route {{ route }} | {{ startstage }} to {{ endstage }} lists all stages/stops on route/bus {{ route }}. It tells you all the stops the bus goes with maps. It also tells you timings of the bus.">
  <meta name="keywords" content="dtc, bus, delhi bus, bus routes, delhi bus route,  delhi bus service, dtc bus, dtc bus service, dtc routes, delhi buses, delhi bus list, delhi bus timings, delhi bus details, delhi bus rote details, delhi transport corporation, delhi bus banner, bus in delhi, bus for delhi, bus for south delhi, bus for north delhi, bus for east delhi, buses in delhi,  delhi bus details, delhi bus route finder, delhi bus route no, delhi bus details, delhi bus route chart, delhi bus route search, dtc route {{ route }}, delhi bus route {{ route }}, dtc {{ route }}">

  <meta itemprop="name" content="DTC Bus Routes | Route {{ route }} | {{ startstage }} to {{ endstage }}">
  <meta itemprop="description" content="DTC Bus Routes | Route {{ route }} | {{ startstage }} to {{ endstage }} lists all stages/stops on route/bus {{ route }}. It tells you all the stops the bus goes with maps. It also tells you timings of the bus.">

  <meta property="og:title" content="DTC Bus Routes | Route {{ route }} | {{ startstage }} to {{ endstage }}" />
  <meta property="og:description" content="DTC Bus Routes | Route {{ route }} | {{ startstage }} to {{ endstage }} lists all stages/stops on route/bus {{ route }}. It tells you all the stops the bus goes with maps. It also tells you timings of the bus." />

  <meta name="twitter:title" content="DTC Bus Routes | Route {{ route }} | {{ startstage }} to {{ endstage }}">
  <meta name="twitter:description" content="DTC Bus Routes | Route {{ route }} | {{ startstage }} to {{ endstage }} lists all stages/stops on route/bus {{ route }}. It tells you all the stops the bus goes with maps. It also tells you timings of the bus.">
{% endblock %}

{% block css %}
    {{ block.super }}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/leaflet.awesome-markers.css">
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/1.5.2/css/ionicons.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
   integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
   crossorigin=""/>
   <link rel="stylesheet" href="https://cdn.maptiler.com/mapbox-gl-js/v0.53.0/mapbox-gl.css" />
    <style>
        #infobox {
            float:left;
        }
        #stops {
            margin-top: 6%;
        }
        #content, #map {
            margin-top: 40px;
            height:100%;
        }
        #map {
            border: 1px dashed grey;
            padding-bottom:45%;
        }
        .leaflet-popup-close-button {
          display: none;
        }
    </style>
{% endblock %}


{% block body %}
    <div class="grid">
     <div class="row">
        <!-- <div class="span2"></div> -->
        <div id="content" class="span4 offset2">
           <div id="infobox">
            {% if route.route_type == 2 %}
            <div class="tile bg-color-orange" style="width:200px;height:auto;">
            {% else %}
            <div class="tile bg-color-green" style="width:200px;height:auto;">
            {% endif %}
                <div class="tile-content">
                    <b itemscope itemtype="http://schema.org/BusTrip">
                        Route : <span itemprop="busName busNumber">{{ route.name }}</span> <br/>
                        Operator: {{ route.get_route_type_display }} <br/>
                        From : {{ startstage }} <br/>
                        To : {{ endstage }} <br />
                    </b>
                </div>
            </div>
            </div>

           <div id="stops" class="span4">
                <b> Stops At: </b> <br /> <br />
                {% for item in stops %}
                <p itemscope itemtype="http://schema.org/BusStop">
                    {{item.sequence}}. <span id="res" rel="tooltip" data-placement="right" data-id="{{item.stage.id}}" itemprop="name" data-index="{{item.sequence}}">{{item.stage}} <span id="eta{{item.stage.id}}"></span></span>
                </p>
                {% endfor %}
          </div>
        </div>
        <div id="map" class="span10"></div>
     </div>
    </div>
{% endblock %}

{% block js %}
{{ block.super }}
<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
   integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
   crossorigin=""></script>
<script src="https://cdn.maptiler.com/mapbox-gl-js/v0.53.0/mapbox-gl.js"></script>
<script src="https://cdn.maptiler.com/mapbox-gl-leaflet/latest/leaflet-mapbox-gl.js"></script>

<script type="text/javascript">
var static_url = "{{ STATIC_URL }}";
</script>
<script type="text/javascript" src="{{ STATIC_URL }}js/maps.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/leaflet.awesome-markers.min.js"></script>
<script>
        var stopMarker = L.AwesomeMarkers.icon({
            icon: 'bus',
            prefix: 'icon',
            {% if route.route_type == 2 %}
            markerColor: 'orange'
            {% else %}
            markerColor: 'green'
            {% endif %}
        });

        var liveBusMarker = L.AwesomeMarkers.icon({
            icon: 'bus',
            prefix: 'fa',
            markerColor: 'blue'
        });


        L.AwesomeMarkers.Icon.prototype.options.prefix = 'ion';

        var bus_route_geojson = {
            "type": "FeatureCollection",
            "features": [{
                "type": "Feature",
                "properties": {
                    "coordTimes":[],
                    'marker-size': 'large',
                    'marker-symbol': 'bus',
                    {% if route.route_type == 2 %}
                    "marker-color": "#e3a21a",
                    "color": "#e3a21a"
                    {% else %}
                    "marker-color": "#00a300",
                    "color": "#00a300"
                    {% endif %}
                },
                "geometry": {
                    type: 'LineString',
                    coordinates: []
                }
            }]
        };

        var bus_stops_geojson = [];

        {% for item in stops %}
            {% if not item.coordinates.longitude == 0 and not item.stage.coordinates.latitude == 0 %}
            bus_route_geojson.features[0].geometry.coordinates.push([
                {{item.stage.coordinates.longitude}},
                {{item.stage.coordinates.latitude}}
            ]);
            bus_route_geojson.features[0].properties.coordTimes.push(
                new Date().getTime()
            );
            bus_stops_geojson.push({
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates":[
                        {{item.stage.coordinates.longitude}},
                        {{item.stage.coordinates.latitude}}
                    ]
                },
                "properties": {
                    "title": "{{ item.stage.name }}",
                    "marker-size": "medium",
                    "marker-symbol": "{{ forloop.counter }}",
                    {% if route.route_type == 2 %}
                    "marker-color": "#e3a21a",
                    "color": "#e3a21a"
                    {% else %}
                    "marker-color": "#00a300",
                    "color": "#00a300"
                    {% endif %}
                }
            });
            {% endif %}
        {% endfor %}

        lat = null;
        lng = null;

        var middle = bus_stops_geojson[Math.round((bus_stops_geojson.length - 1) / 2)];
        if (middle == null || middle == undefined) {
            lat = 28.6129;
            lng = 77.2295;
        } else {
            lat = middle.geometry.coordinates[1];
            lng = middle.geometry.coordinates[0];
        }

        var map = L.map('map').setView([lat, lng], 12);
        // var openstreetmap = L.tileLayer(
        //     'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        //         attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
        // })
        // openstreetmap.addTo(map);
        var gl = L.mapboxGL({
            attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">© MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">© OpenStreetMap contributors</a>',
            accessToken: 'not-needed',
            style: 'https://api.maptiler.com/maps/streets/style.json?key=5nG2rAE49EnkLpvV60VK'
        }).addTo(map);
        L.control.layers(null,overlayMaps).addTo(map);

        function onEachFeature(feature, layer) {
            var popupContent = "";

            if (feature.properties && feature.properties.title) {
                popupContent += feature.properties.title;
                layer.bindPopup(popupContent);
            }
        }

        bus_route_geojson.features.push(...bus_stops_geojson);
        var bus_stop_layer = L.geoJson(bus_route_geojson, {
            onEachFeature: onEachFeature,
            pointToLayer: function (feature, latlng) {
                return L.marker(latlng, {icon: stopMarker});
            }
        }).addTo(map);

        bus_stop_layer.on('click', function(e) {
            map.setView(e.latlng);
        });

        var allStageMarkers = {};
        bus_stop_layer.eachLayer(function(layer) {
            if (layer.feature.properties["marker-symbol"]) {
                allStageMarkers[layer.feature.properties["marker-symbol"]] = layer;
            }
        });

        $(document).ready(function (){
            $('body').tooltip({
                selector: '[rel=tooltip]'
            });

            $(document).on('mouseenter', 'span[rel=tooltip]', function () {
                var ele = $(this),
                    index = ele.data().index,
                    id = ele.data().id,
                    originaltitle = ele.attr('data-original-title');

                if (originaltitle === "" || originaltitle === undefined) {
                    $.get("{% url 'ajax_buses_from_here' %}?id=" + encodeURIComponent(id),

                    function (response) {
                        ele.attr("data-original-title", response);
                    });
                }
                $(this).tooltip('show');

                var coordinates = bus_stops_geojson[index-1].geometry.coordinates;
                coordinates = [].concat(coordinates).reverse();

                var marker = new L.LatLng(coordinates[0],coordinates[1]);
                map.setView(marker);

                allStageMarkers[index].openPopup();
            });

            $(document).on('mouseleave', 'span[rel=tooltip]', function () {
                var ele = $(this);
                var index = ele.data().index;
                allStageMarkers[index].closePopup();
                $(this).tooltip('hide');
            });


            {% if route.route_type == 2 %}
            var realtime_bus_markers = {}

            tick();
            function tick() {

                $.ajax({
                    'type': 'GET',
                    'url': "{% url 'route_eta' %}?route_id={{route.id}}",
                    'cache': false,
                    'dataType': 'json',

                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("Authorization", "Token {{ access_token }}");
                    }
                }).done(function(data) {
                    // update eta
                    if (data["data"]["stages"]) {
                        for(var i=0; i<data["data"]["stages"].length; ++i) {
                            stage = data["data"]["stages"][i]
                            if (stage["eta_minutes"]) {
                                var eta_string = "(ETA: "+stage["eta_minutes"].join()+" minutes)"
                                $("#eta"+stage["id"]).text(eta_string)
                            }
                        }
                    }

                    // populate vehicle data
                    if (data["data"]["vehicle_list"]) {
                        for(var i=0; i<data["data"]["vehicle_list"].length; ++i){
                            vehicle = data["data"]["vehicle_list"][i];

                            if (realtime_bus_markers[vehicle["vehicle_number"]] == null || realtime_bus_markers[vehicle["vehicle_number"]] === undefined) {
                                var marker =  L.marker(
                                    [vehicle["latitude"],vehicle["longitude"]], {
                                  icon: L.mapbox.marker.icon({
                                    'marker-color': '#548cba',
                                    "marker-size": "large",
                                    "marker-symbol": "bus",
                                })}).addTo(map);

                                marker.bindPopup(
                                    "<b>"+vehicle["vehicle_number"]+"</b><br/>"+
                                    "Location: "+vehicle["location"]+"<br />"+
                                    "Seat Availability: "+vehicle["seat_availability"]).openPopup();

                                realtime_bus_markers[vehicle["vehicle_number"]] = marker;
                            } else {
                                var marker = realtime_bus_markers[vehicle["vehicle_number"]]

                                marker.setLatLng(L.latLng(
                                    vehicle["latitude"],
                                    vehicle["longitude"]));

                                marker.setPopupContent(
                                    "<b>"+vehicle["vehicle_number"]+"</b><br/>"+
                                    "Location: "+vehicle["location"]+"<br />"+
                                    "Seat Availability: "+vehicle["seat_availability"]).openPopup();
                            }
                        }
                    }
                }).fail(function() {
                    console.log("realtime bus fetch failed!")
                })

                setTimeout(tick, 30000);
            }
            {% endif %}
        });
</script>
{% endblock %}

{% block share %}
{% endblock %}

{% block bottom_responsive_ad %}
{% endblock %}
